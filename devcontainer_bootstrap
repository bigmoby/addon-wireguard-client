#!/bin/bash
# Bootstrap script for Home Assistant devcontainer
# Fixes Docker mount propagation issues

set -e

echo "ðŸ”§ Setting up Docker mount propagation..."

# Create supervisor directories
mkdir -p /mnt/supervisor/{share,addon_configs}
echo "âœ“ Supervisor directories created"

# Check if /mnt/supervisor/share is already a mount point
if mountpoint -q /mnt/supervisor/share 2>/dev/null; then
    echo "âœ“ /mnt/supervisor/share is already mounted"
    # Try to make it shared if it's not already
    mount --make-shared /mnt/supervisor/share 2>/dev/null || \
    mount --make-rshared /mnt/supervisor/share 2>/dev/null || \
    echo "âš  Could not make /mnt/supervisor/share shared"
else
    # Try to mount tmpfs if not already mounted
    if mount -t tmpfs -o size=100M tmpfs /mnt/supervisor/share 2>/dev/null; then
        echo "âœ“ tmpfs montato su /mnt/supervisor/share"
    else
        echo "â„¹ /mnt/supervisor/share non montato (verrÃ  creato automaticamente)"
    fi
fi

# Try to make root mount shared (required for Docker-in-Docker)
# This might fail if we don't have sufficient privileges
if mount --make-shared / 2>/dev/null || mount --make-rshared / 2>/dev/null; then
    echo "âœ“ Root mount configured as shared"
else
    # Check if it's already shared
    if grep -q "shared:" /proc/self/mountinfo | grep " / "; then
        echo "âœ“ Root mount is already shared"
    else
        echo "âš  Could not configure root mount as shared"
        echo "  This may cause issues with Docker-in-Docker"
    fi
fi

echo ""
echo "âœ… Bootstrap complete"

